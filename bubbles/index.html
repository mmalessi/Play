<!DOCTYPE html>
<html>
<head>
	<title>Bubble Expertise</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
	<style>
		html, body {
			padding: 0;
			margin: 0;
			box-sizing: border-box;
			font-family: 'Montserrat', sans-serif;
		}
		* {
			box-sizing: inherit;
		}
		h1 {
			text-align: center;
		}
		svg {
			margin:auto;
			display:block;
		}
		.circle-overlay {
			font-size: 16px;
			border-radius: 30%;
			position: absolute;
			overflow: hidden;
            font-family:'Montserrat', sans-serif;
			/*it's buggy with the foreignObject background right now*/
			/*background-color: rgba(255,255,255,0.5);*/
		}
		.circle-overlay__inner {
			text-align: center;
			width: 100%;
			height: 100%;
		}
		.hidden {
			display: none;
		}
		.node-icon--faded {
			opacity: 0.3;
		}
		.legend-size circle {
			fill: rgb(31, 119, 180);
		}
	</style>
</head>
<body>
	<h1>Expertise</h1>
	<svg width="100%" height="700" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>

	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.js"></script>
	<script>
		// Based loosely from this D3 bubble graph https://bl.ocks.org/mbostock/4063269
		// And this Forced directed diagram https://bl.ocks.org/mbostock/4062045
		let data = [{
			cat: 'Afterschool', name: 'Afterschool', value: 6,
            icon: 'aoenames/12.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. 
			`
		}, {
			cat: 'Curriculum & Instruction', name: 'Curriculum & Instruction', value: 16,
            icon: 'aoenames/19.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'D.E.I.', name: 'D.E.I.', value: 21,
            icon: 'aoenames/dei-19.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Early childhood', name: 'Early childhood', value: 2,
            icon: 'aoenames/ec.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Earned Rev.', name: 'Earned Rev.', value: 3,
            icon: 'aoenames/06.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. `
		}, {
			cat: 'Fundraising', name: 'Fundraising', value: 7,
            icon: 'aoenames/fundraising-16.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Governance', name: 'Governance', value: 10,
            icon: 'aoenames/03.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Higher Ed./C.T.E.', name: 'Higher Ed./C.T.E.', value: 5,
            icon: 'aoenames/13.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Human Capital', name: 'Human Capital', value: 33,
            icon: 'aoenames/human_capital-12.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		},  {
			cat: 'Marketing & Communications', name: 'Marketing & Communications', value: 10,
            icon: 'aoenames/m.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Ops & Finance', name: 'Ops & Finance', value: 16,
            icon: 'aoenames/14.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Org. Culture', name: 'Org. Culture', value: 20,
            icon: 'aoenames/08.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Other', name: 'Other', value: 22,
            icon: 'aoenames/other-20.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'PL/PB', name: 'PL/PB', value: 13,
            icon: 'aoenames/15.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Program Design', name: 'Program Design', value: 64,
            icon: 'aoenames/program_design-18.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Program Eval.', name: 'Program Eval.', value: 18,
            icon: 'aoenames/17.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Special Ed.', name: 'Special Ed.', value: 9,
            icon: 'aoenames/se.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Start-up Support', name: 'Start-up Support', value: 22,
            icon: 'aoenames/07.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}, {
			cat: 'Tech. & Data Systems', name: 'Tech. & Data Systems', value: 9,
            icon: 'aoenames/tds-21.png',
			desc: `
				Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam in consequat augue. Nunc blandit quis lectus bibendum fringilla. Quisque ac nunc vel quam commodo egestas. Vestibulum nec maximus ex. 
			`
		}
                   ];
	</script>

	<script>
		let svg = d3.select('svg');
		let width = document.body.clientWidth; // get width in pixels
		let height = +svg.attr('height');
		let centerX = width * 0.5;
		let centerY = height * 0.5;
		let strength = 0.05;
		let focusedNode;
		let format = d3.format(',d');

var color = d3.scaleOrdinal()
    .domain(["Afterschool", "Curriculum & Instruction", "D.E.I.", "Early childhood", "Earned Rev.", "Fundraising", "Governance", "Higher Ed./C.T.E.", "Human Capital", "Marketing & Communications", "Ops & Finance", "Org. Culture","Other","PL/PB","Program Eval.","Special Ed.","Start-up Support","Tech. & Data Systems"])
    .range(["#ffc0cb", "#00e5e6", "#e86478", "#ffd700", "#00ffff", "#40e0d0", "#ff7373", "#e6e6fa", "#d3ffce", "#ffa500", "#b0e0e6", "#7fffd4","#ff4d4d", "#4da6ff", "#f6546a", "#fff68f", "#66cdaa", "#ff80ff"]);
		// use pack to calculate radius of the circle
		let pack = d3.pack()
			.size([width , height ])
			.padding(1.5);
		let forceCollide = d3.forceCollide(d => d.r + 1);
		// use the force
		let simulation = d3.forceSimulation()
			// .force('link', d3.forceLink().id(d => d.id))
			.force('charge', d3.forceManyBody())
			.force('collide', forceCollide)
			// .force('center', d3.forceCenter(centerX, centerY))
			.force('x', d3.forceX(centerX ).strength(strength))
			.force('y', d3.forceY(centerY ).strength(strength));
		// reduce number of circles on mobile screen due to slow computation
		if ('matchMedia' in window && window.matchMedia('(max-device-width: 767px)').matches) {
			data = data.filter(el => {
				return el.value >= 50;
			});
		}
		let root = d3.hierarchy({ children: data })
			.sum(d => d.value);
		// we use pack() to automatically calculate radius conveniently only
		// and get only the leaves
		let nodes = pack(root).leaves().map(node => {
			console.log('node:', node.x, (node.x - centerX) * 2);
			const data = node.data;
			return {
				x: centerX + (node.x - centerX) * 3, // magnify start position to have transition to center movement
				y: centerY + (node.y - centerY) * 3,
				r: 0, // for tweening
				radius: node.r, //original radius
				id: data.cat + '.' + (data.name.replace(/\s/g, '-')),
				cat: data.cat,
				name: data.name,
				value: data.value,
				icon: data.icon,
				desc: data.desc,
			}
		});
		simulation.nodes(nodes).on('tick', ticked);
		svg.style('background-color', 'white');
		let node = svg.selectAll('.node')
			.data(nodes)
			.enter().append('g')
			.attr('class', 'node')
			.call(d3.drag()
				.on('start', (d) => {
					if (!d3.event.active) simulation.alphaTarget(0.2).restart();
					d.fx = d.x;
					d.fy = d.y;
				})
				.on('drag', (d) => {
					d.fx = d3.event.x;
					d.fy = d3.event.y;
				})
				.on('end', (d) => {
					if (!d3.event.active) simulation.alphaTarget(0);
					d.fx = null;
					d.fy = null;
				}));
        function lightness(hex, lum) {

            // validate hex string
            hex = String(hex).replace(/[^0-9a-f]/gi, '');
            if (hex.length < 6) {
                hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
            }
            lum = lum || 0;

            // convert to decimal and change luminosity
            var rgb = "#", c, i;
            for (i = 0; i < 3; i++) {
                c = parseInt(hex.substr(i*2,2), 16);
                c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
                rgb += ("00"+c).substr(c.length);
            }

            return rgb;
        }
        
        function textColor (bubble_color){
            if (lightness(bubble_color) > 50) {
                return "#000000";
            }
            else {
               return "#ffffff";
            }
        }
		node.append('circle')
			.attr('id', d => d.id)
			.attr('r', 0)
			.style('fill', d => color(d.cat))
			.transition().duration(2000).ease(d3.easeElasticOut)
				.tween('circleIn', (d) => {
					let i = d3.interpolateNumber(0, d.radius);
					return (t) => {
						d.r = i(t);
						simulation.force('collide', forceCollide);
					}
				})
		node.append('clipPath')
			.attr('id', d => `clip-${d.id}`)
			.append('use')
			.attr('xlink:href', d => `#${d.id}`);
		// display text as circle icon
		node.filter(d => !String(d.icon))
			.append('text')
            .style("fill","white")
			.classed('node-icon', true)
			.attr('clip-path', d => `url(#clip-${d.id})`)
			.selectAll('tspan')
			.data(d => d.icon.split(';'))
			.enter()
				.append('tspan')
				.attr('x', 0)
				.attr('y', (d, i, nodes) => (13 + (i - nodes.length / 2 - 0.5) * 10))
				.text(name => name);
		// display image as circle icon
        
        //        .style("fill", function(d){return textColor(color(d.cat))});
       
		node.filter(d => String(d.icon))/*.includes('img/'))*/
			.append('image')
			.classed('node-icon', true)
			.attr('clip-path', d => `url(#clip-${d.id})`)
			.attr('xlink:href', d => d.icon)
			.attr('x', d => - d.radius * 0.7)
			.attr('y', d => - d.radius * 0.7)
			.attr('height', d => d.radius * 2 * 0.7)
			.attr('width', d => d.radius * 2 * 0.7)
		node.append('title')
			.text(d => (d.cat + '::' + d.name + '\n' + format(d.value)))
		let legendOrdinal = d3.legendColor()
			.scale(color)
			.shape('circle');
		let legend = svg.append('g')
			.classed('legend-color', true)
			.attr('text-anchor', 'start')
			.attr('transform','translate(20,30)')
			.style('font-size','12px')
			.call(legendOrdinal);
		let sizeScale = d3.scaleOrdinal()
  			.domain(['less experts', 'more experts'])
  			.range([5, 10] );
		let legendSize = d3.legendSize()
			.scale(sizeScale)
			.shape('circle')
			.shapePadding(10)
			.labelAlign('end');
		let legend2 = svg.append('g')
			.classed('legend-size', true)
			.attr('text-anchor', 'start')
			.attr('transform', 'translate(200, 25)')
			.style('font-size', '12px')
			.call(legendSize);

		let infoBox = node.append('foreignObject')
			.classed('circle-overlay hidden', true)
			.attr('x', -350 * 0.5 * 0.8)
			.attr('y', -350 * 0.5 * 0.8)
			.attr('height', 350 * 0.8)
			.attr('width', 350 * 0.8)
				.append('xhtml:div')
				.classed('circle-overlay__inner', true);
		infoBox.append('h2')
			.classed('circle-overlay__title', true)
			.text(d => d.name);
		infoBox.append('p')
			.classed('circle-overlay__body', true)
			.html(d => d.desc);
       // .style("fill", function(d){return console.log(textColor(color(d.cat)))});
        
        // d3.selectAll("#circle-overlay__body").style("fill", function(d){return console.log(textColor(color(d.cat)))});

		node.on('click', (currentNode) => {
			d3.event.stopPropagation();
			console.log('currentNode', currentNode);
			let currentTarget = d3.event.currentTarget; // the <g> el
			if (currentNode === focusedNode) {
				// no focusedNode or same focused node is clicked
				return;
			}
			let lastNode = focusedNode;
			focusedNode = currentNode;
			simulation.alphaTarget(0.2).restart();
			// hide all circle-overlay
			d3.selectAll('.circle-overlay').classed('hidden', true);
			d3.selectAll('.node-icon').classed('node-icon--faded', false);
			// don't fix last node to center anymore
			if (lastNode) {
				lastNode.fx = null;
				lastNode.fy = null;
				node.filter((d, i) => i === lastNode.index)
					.transition().duration(2000).ease(d3.easePolyOut)
					.tween('circleOut', () => {
						let irl = d3.interpolateNumber(lastNode.r, lastNode.radius);
						return (t) => {
							lastNode.r = irl(t);
						}
					})
					.on('interrupt', () => {
						lastNode.r = lastNode.radius;
					});
			}
			// if (!d3.event.active) simulation.alphaTarget(0.5).restart();
			d3.transition().duration(2000).ease(d3.easePolyOut)
				.tween('moveIn', () => {
					console.log('tweenMoveIn', currentNode);
					let ix = d3.interpolateNumber(currentNode.x, centerX);
					let iy = d3.interpolateNumber(currentNode.y, centerY);
					let ir = d3.interpolateNumber(currentNode.r, centerY * 0.5);
					return function (t) {
						// console.log('i', ix(t), iy(t));
						currentNode.fx = ix(t);
						currentNode.fy = iy(t);
						currentNode.r = ir(t);
						simulation.force('collide', forceCollide);
					};
				})
				.on('end', () => {
					simulation.alphaTarget(0);
					let $currentGroup = d3.select(currentTarget);
					$currentGroup.select('.circle-overlay')
						.classed('hidden', false);
					$currentGroup.select('.node-icon')
						.classed('node-icon--faded', true);
				})
				.on('interrupt', () => {
					console.log('move interrupt', currentNode);
					currentNode.fx = null;
					currentNode.fy = null;
					simulation.alphaTarget(0);
				});
		});
		// blur
		d3.select(document).on('click', () => {
			let target = d3.event.target;
			// check if click on document but not on the circle overlay
			if (!target.closest('#circle-overlay') && focusedNode) {
				focusedNode.fx = null;
				focusedNode.fy = null;
				simulation.alphaTarget(0.2).restart();
				d3.transition().duration(2000).ease(d3.easePolyOut)
					.tween('moveOut', function () {
						console.log('tweenMoveOut', focusedNode);
						let ir = d3.interpolateNumber(focusedNode.r, focusedNode.radius);
						return function (t) {
							focusedNode.r = ir(t);
							simulation.force('collide', forceCollide);
						};
					})
					.on('end', () => {
						focusedNode = null;
						simulation.alphaTarget(0);
					})
					.on('interrupt', () => {
						simulation.alphaTarget(0);
					});
				// hide all circle-overlay
				d3.selectAll('.circle-overlay').classed('hidden', true);
				d3.selectAll('.node-icon').classed('node-icon--faded', false);
			}
		});
		function ticked() {
			node
				.attr('transform', d => `translate(${d.x},${d.y})`)
				.select('circle')
					.attr('r', d => d.r);
		}
	</script>
</body>
</html>
