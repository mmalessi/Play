<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
	<style>
		html, body {
			padding: 0;
			margin: 0;
			box-sizing: border-box;
			font-family: 'Montserrat', sans-serif;
		}
		* {
			box-sizing: inherit;
		}
		h1 {
			text-align: center;
		}
		svg {
			margin:auto;
			display:block;
            padding-top: 2%;
            padding-left: 2%;
		}
		.circle-overlay {
			font-size: 14px;
			border-radius: 30%;
			position: absolute;
			overflow: hidden;
            font-family:'Montserrat', sans-serif;
			/*it's buggy with the foreignObject background right now*/
			/*background-color: rgba(255,255,255,0.5);*/
		}
		.circle-overlay__inner {
			text-align: center;
			width: 100%;
			height: 100%;
		}
		.hidden {
			display: none;
		}
		.node-icon--faded {
			opacity: 0.3;
		}
		.legend-size circle {
			fill: rgb(31, 119, 180);
		}
        
        .tooltip {
            /*content: " ";*/
            position: absolute;
            top: 100%; /* At the bottom of the tooltip */
            left: 10%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: black transparent transparent transparent;
        }
        .tooltip .tooltiptext {
            width: 120px;
            background-color: black;
            color: #fff;
            text-align: center;
            padding: 5px 0;
            border-radius: 6px;

            /* Position the tooltip text - see examples below! */
            position: absolute;
            z-index: 1;
        }

	</style>
</head>
<body>
	<svg class = "legend3" width="100%" height="700" padding-top="5px" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>
    
    
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.js"></script>
	<script>
		// Based loosely from this D3 bubble graph https://bl.ocks.org/mbostock/4063269
		// And this Forced directed diagram https://bl.ocks.org/mbostock/4062045
		let data = [{
			cat: 'Afterschool & Early Childhood', name: 'Afterschool & Early Childhood', project: 'E.g. Strategic Planning, Program Evaluation, Earned Revenue Strategies, Board Development.',number:'8 Experts', value: 8,
            icon: 'aoenames/afterschool-27.png',
			desc: `
				Developing strategies and programs for afterschool programs.
			`
		}, {
			cat: 'Curriculum & Instruction', name: 'Curriculum, Instruction', value: 16, project: 'E.g. Instructional Model Design; Curriculum and Assessments Development/Adaptation; Intervention Block Design; Teacher Professional Development', number: '16 Experts',
            icon: 'aoenames/ca-30.png',
			desc: `
				Developing rigorous and aligned instructional models, curricula, and assessments.
			`
		}, {
			cat: 'D.E.I.', name: 'D.E.I.', value: 21, project: 'E.g. DEI Assessment; DEI Vision and Strategy Development; Diverse Team and Board Recruitment; Building Inclusive Culture.', number: '21 Experts',
            icon: 'aoenames/dei-19.png',
			desc: `
				Infusing diversity, equity and inclusion across all aspects of an organization, from strategy to human capital to program outcomes.
			`
		},  {
			cat: 'Fundraising', name: 'Fundraising', value: 10, project: 'E.g. Fundraising Plan; Grant Proposal Template, Earned Revenue Strategy Development.', number: '10 Experts',
            icon: 'aoenames/fundraising-16.png',
			desc: `
				Resourcing organizations through fundraising, grant writing, and earned revenue strategy.
			`
		}, {
			cat: 'Governance', name: 'Governance', value: 10, project:'E.g. Board Roles and Expectations; Board Recruitment; Governance Protocols and Practices; Board Training and Management.', number:'10 Experts',
            icon: 'aoenames/governance-26.png',
			desc: `
				Assisting organizations in setting governance protocols and practices, and building a strong and supportive board.
			`
		}, {
			cat: 'Higher Ed./C.T.E.', name: 'Higher Ed./C.T.E.', value: 5, project:'Eg. Supports for Minority Serving Institutions; Program Design to Support Underserved Student Populations.', number:'5 Experts.',
            icon: 'aoenames/hecte-28.png',
			desc: `
				Developing strategies and programs for Higher Ed and CTE institutions.
			`
		}, {
			cat: 'Human Capital', name: 'Human Capital', value: 33, project: 'E.g. Recruitment, Hiring, and Onboarding Support; Staff Professional Development Plans; Staff Evaluation and Feedback; Compensation Review.', number: '33 Experts',
            icon: 'aoenames/human_capital-12.png',
			desc: `
				Recruiting, developing, and retaining a high-performing team.
			`
		},  {
			cat: 'Marketing & Communications', name: 'Marketing & Communications', value: 10, project: 'Eg. Brand Identity Development; Launch Communications; One Pager Creation; Video Development.', number: '10 Experts',
            icon: 'aoenames/m.png',
			desc: `
				Creating and communicating compelling narratives for organizations. 
			`
		}, {
			cat: 'Ops & Finance', name: 'Ops & Finance', value: 16, project:'E.g. Budget Development; Pricing Tool Development; Finance + Accounting Review; Operations Plan Development; Legal Guidance.', number: '16 Experts',
            icon: 'aoenames/opsfin-29.png',
			desc: `
				 Building effective and efficient financial, legal, and operational support services.
			`
		}, {
			cat: 'Org. Culture', name: 'Org. Culture', value: 20, project:'E.g. Organizational Values, Norms, and Expectations; Discipline; Restorative Practices; DEI; Student and Staff Handbooks.', number:'20 Experts',
            icon: 'aoenames/soc-34.png',
			desc: `
				Developing a strong and inclusive culture.
			`
		}, {
			cat: 'Other', name: 'Other', value: 22, project:'E.g. Policy, Early Childhood, Research, Socio-emotional Learning, Event Planning, etc.', number:'22 Experts',
            icon: 'aoenames/other-20.png',
			desc: `
				This includes all categories where we have 5 or fewer experts.
			`
		}, {
			cat: 'PL/PB', name: 'PL/PB', value: 13, project: 'E.g. Personalized Learning Strategy; Technology Selection; Implementation Support; Professional Development', number:'13 Experts',
            icon: 'aoenames/plpb-23.png',
			desc: `
				Implementing rigorous and aligned personalized learning models.
			`
		}, {
			cat: 'Program Design', name: 'Program Design', value: 64, project: "E.g. Strategic Plan Development; Business Plan Development; Theory of Change; Pilot Design.", number: "64 Experts",
            icon: 'aoenames/program_design-18.png',
			desc: `Designing an innovative and robust program or mapping out an organizationâ€™s future direction.
			`
		}, {
			cat: 'Program Eval.', name: 'Program Eval.', value: 18, project: 'E.g. Evaluation Design; Developmental, Formative and Summative Evaluation.', number: '18 experts',
            icon: 'aoenames/pe-24.png',
			desc: `
				Measuring, gathering, and analyzing data to capture learnings and evaluate program results. 
			`
		}, {
			cat: 'Diverse Learners', name: 'Diverse Learners', value: 9, project:'E.g. Plan for Meeting Needs of Diverse Learners; Professional Development for Teachers', number: '9 Experts',
            icon: 'aoenames/ec.png',
			desc: `
				Identifying and meeting the needs of diverse learners (children with disabilities, ELL students, gifted students, etc.). 
			`
		}, {
			cat: 'Start-up Support', name: 'Start-up Support', value: 22, project: 'E.g. 501c3 application; Charter Application Development or Review; Launch Project Plan Development.', number: '22 Experts',
            icon: 'aoenames/sus-32.png',
			desc: `
				Getting help with crucial elements of starting an organization or school.
			`
		}, {
			cat: 'Tech. & Data Systems', name: 'Tech. & Data Systems', value: 9, project: 'E.g. Data Dashboard Creation; Tech Tool Identification or Development; Website Development', number: '9 Experts',
            icon: 'aoenames/tds-21.png',
			desc: `
				Leveraging technology to improve operations and outcomes.
			`
		}
                   ];
	</script>

	<script>
		let svg = d3.select('svg');
		let width = document.body.clientWidth; // get width in pixels
		let height = +svg.attr('height');
		let centerX = width * 0.5;
		let centerY = height * 0.5;
		let strength = 0.05;
		let focusedNode;
		let format = d3.format(',d');

var color = d3.scaleOrdinal()
    .domain(["Afterschool & Early Childhood", "Curriculum & Instruction", "D.E.I.", "Fundraising", "Governance", "Higher Ed./C.T.E.", "Human Capital", "Marketing & Communications", "Ops & Finance", "Org. Culture","Other","PL/PB","Program Eval.","Diverse Learners","Start-up Support","Tech. & Data Systems"])
    .range(["#ffc0cb", "#00e5e6", "#e86478", "#40e0d0", "#ff7373", "#e6e6fa", "#d3ffce", "#ffa500", "#b0e0e6", "#7fffd4","#ff4d4d", "#dcf3ff", "#f6546a", "#fff68f", "#e3f6c1", "#ff80ff"]);
        
var symbol = d3.scaleOrdinal()
    .domain(["Afterschool & Early Childhood", "Curriculum & Instruction", "D.E.I.","Diverse Learners", "Fundraising", "Governance", "Higher Ed./C.T.E.", "Human Capital", "Marketing & Communications", "Ops & Finance", "Org. Culture","Other","PL/PB", "Program Design", "Program Eval.","Start-up Support","Tech. & Data Systems"])
    .range(["aoenames/afterschool-27.png", "aoenames/ca-30.png", "aoenames/dei-19.png", "aoenames/ec.png", "aoenames/fundraising-16.png", "aoenames/governance-26.png", "aoenames/hecte-28.png", "aoenames/human_capital-12.png", "aoenames/m.png", "aoenames/opsfin-29.png", "aoenames/soc-34.png","aoenames/other-20.png", "aoenames/plpb-23.png", "aoenames/program_design-18.png", "aoenames/pe-24.png", "aoenames/sus-32.png", "aoenames/tds-21.png"]);
        
        
		// use pack to calculate radius of the circle
		let pack = d3.pack()
			.size([width , height ])
			.padding(1.5);
		let forceCollide = d3.forceCollide(d => d.r + 1);
		// use the force
		let simulation = d3.forceSimulation()
			// .force('link', d3.forceLink().id(d => d.id))
			.force('charge', d3.forceManyBody())
			.force('collide', forceCollide)
			// .force('center', d3.forceCenter(centerX, centerY))
			.force('x', d3.forceX(centerX ).strength(strength))
			.force('y', d3.forceY(centerY ).strength(strength));
		// reduce number of circles on mobile screen due to slow computation
		if ('matchMedia' in window && window.matchMedia('(max-device-width: 767px)').matches) {
			data = data.filter(el => {
				return el.value >= 50;
			});
		}
		let root = d3.hierarchy({ children: data })
			.sum(d => d.value);
		// we use pack() to automatically calculate radius conveniently only
		// and get only the leaves
		let nodes = pack(root).leaves().map(node => {
			console.log('node:', node.x, (node.x - centerX) * 2);
			const data = node.data;
			return {
				x: centerX + (node.x - centerX) * 3, // magnify start position to have transition to center movement
				y: centerY + (node.y - centerY) * 3,
				r: 0, // for tweening
				radius: node.r, //original radius
				id: data.cat + '.' + (data.name.replace(/\s/g, '-')),
				cat: data.cat,
				name: data.name,
                project: data.project,
                number: data.number,
				value: data.value,
				icon: data.icon,
				desc: data.desc,
			}
		});
		simulation.nodes(nodes).on('tick', ticked);
		svg.style('background-color', 'white');
		let node = svg.selectAll('.node')
			.data(nodes)
			.enter().append('g')
			.attr('class', 'node')
			.call(d3.drag()
				.on('start', (d) => {
					if (!d3.event.active) simulation.alphaTarget(0.2).restart();
					d.fx = d.x;
					d.fy = d.y;
				})
				.on('drag', (d) => {
					d.fx = d3.event.x;
					d.fy = d3.event.y;
				})
				.on('end', (d) => {
					if (!d3.event.active) simulation.alphaTarget(0);
					d.fx = null;
					d.fy = null;
				}));
        function lightness(hex, lum) {

            // validate hex string
            hex = String(hex).replace(/[^0-9a-f]/gi, '');
            if (hex.length < 6) {
                hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
            }
            lum = lum || 0;

            // convert to decimal and change luminosity
            var rgb = "#", c, i;
            for (i = 0; i < 3; i++) {
                c = parseInt(hex.substr(i*2,2), 16);
                c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
                rgb += ("00"+c).substr(c.length);
            }

            return rgb;
        }
        
        function textColor (bubble_color){
            if (lightness(bubble_color) > 50) {
                return "#000000";
            }
            else {
               return "#ffffff";
            }
        }
		node.append('circle')
			.attr('id', d => d.id)
			.attr('r', 0)
			.style('fill', d => color(d.cat))
			.transition().duration(2000).ease(d3.easeElasticOut)
				.tween('circleIn', (d) => {
					let i = d3.interpolateNumber(0, d.radius);
					return (t) => {
						d.r = i(t);
						simulation.force('collide', forceCollide);
					}
				})
		node.append('clipPath')
			.attr('id', d => `clip-${d.id}`)
			.append('use')
			.attr('xlink:href', d => `#${d.id}`);
		// display text as circle icon
		node.filter(d => !String(d.icon))
			.append('text')
            .style("fill","white")
			.classed('node-icon', true)
			.attr('clip-path', d => `url(#clip-${d.id})`)
			.selectAll('tspan')
			.data(d => d.icon.split(';'))
			.enter()
				.append('tspan')
				.attr('x', 0)
				.attr('y', (d, i, nodes) => (13 + (i - nodes.length / 2 - 0.5) * 10))
				.text(name => name);
		//display image as circle icon
        
       // .style("fill", function(d){return textColor(color(d.cat))});
       
		node.filter(d => String(d.icon))/*.includes('img/'))*/
			.append('image')
			.classed('node-icon', true)
			.attr('clip-path', d => `url(#clip-${d.id})`)
			.attr('xlink:href', d => d.icon)
			.attr('x', d => - d.radius * 0.7)
			.attr('y', d => - d.radius * 0.7)
			.attr('height', d => d.radius * 2 * 0.7)
			.attr('width', d => d.radius * 2 * 0.7);
        
		/*node.append('title')
            .classed("tootlip", true)
            .text(d => (d.pdesc));*/
		/*let legendOrdinal = d3.legendColor()
			.scale(color)
			.shape('circle')
            //.on("mouseover", function () {return console.log(this)});
            
		let legend = svg.append('g') 
			.classed('legend-color', true)
			.attr('text-anchor', 'start')
			.attr('transform','translate(20,30)')
			.style('font-size','12px')
            .call(legendOrdinal)
            .on("mouseover", function() {console.log(this)});*/
        
         var svgLegend3 = d3.select(".legend3").append("svg")
            .attr("width", width).attr("height", height);
        
        
        function showID() {
            //return this; doesn't work
            ID = this.class;
            alert ('ID is: ' + ID);
        }
        
        //D3 Vertical Legend//////////////////////////
        
        var legend3 = svgLegend3.selectAll('.legend3')
            .data(color.domain())
            .enter().append('g')
            .attr("class", "legends3")
            .attr("transform", function (d, i) {
            {
                return "translate(0," + i * 20 + ")"
            }
        });/*.on('click', function(d,i){
                 d3.selectAll("rect")
                    .style("opacity", 0.1);
                // make the one selected be un-dimmed
                d3.selectAll("circle")
                    .style("opacity", 0.1);
                d3.select(console.log(this))
                    .style("opacity", 1);
                console.log(d);}
               )
        ;*/
        
        legend3.append("svg:image")
            .attr("xlink:href",  function(d) { return symbol(d);})
            .attr("x", function(d) { return -1;})
            .attr("y", function(d) { return -1;})
            .attr("height", 20)
            .attr("width", 20);
        
        
        console.log(color.domain())
        
        /*legend3.append('rect')
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 10)
            .attr("height", 10)
            .style("fill", function (d, i) {
            return color(i)
        });*/
        
        legend3.append('text')
            .attr("x", 20)
            .attr("y", 10)
        //.attr("dy", ".35em")
        .text(function (d, i) {
            return d
        })
            .attr("class", "textselected")
            .style("text-anchor", "start")
            .style("font-size", 15);
		
        let sizeScale = d3.scaleOrdinal()
  			.domain(['fewer experts', 'more experts'])
  			.range([5, 10] );
	
        let legendSize = d3.legendSize()
			.scale(sizeScale)
			.shape('circle')
			.shapePadding(10)
			.labelAlign('end');
        
		let legend2 = svg.append('g')
			.classed('legend-size', true)
			.attr('text-anchor', 'start')
			.attr('transform', 'translate(250, 25)')
			.style('font-size', '12px')
			.call(legendSize);

		let infoBox = node.append('foreignObject')
			.classed('circle-overlay hidden', true)
			.attr('x', -350 * 0.5 * 0.8)
			.attr('y', -350 * 0.5 * 0.8)
			.attr('height', 350 * 0.8)
			.attr('width', 350 * 0.8)
				.append('xhtml:div')
				.classed('circle-overlay__inner', true);
        
        var div = d3.select("body").append("div")	
            .attr("class", "tooltip")				
            .style("opacity", 0);
        
        
		infoBox.append('h2')
			.classed('circle-overlay__title', true)
			.text(d => d.name);
		infoBox.append('p')
			.classed('circle-overlay__body', true)
			.html(d => d.desc);
        infoBox.append('p')
            .classed('circle-overlay__project', true)
            .html(d => d.project);
        infoBox.append('h4')
            .classed('circle-overlay__number', true)
            .html(d => d.number)
        
       // .style("fill", function(d){return console.log(textColor(color(d.cat)))});
        
        // d3.selectAll("#circle-overlay__body").style("fill", function(d){return console.log(textColor(color(d.cat)))});

		node.on('click', (currentNode) => {
			d3.event.stopPropagation();
			console.log('currentNode', currentNode);
			let currentTarget = d3.event.currentTarget; // the <g> el
			if (currentNode === focusedNode) {
				// no focusedNode or same focused node is clicked
				return;
			}
			let lastNode = focusedNode;
			focusedNode = currentNode;
			simulation.alphaTarget(0.2).restart();
			// hide all circle-overlay
			d3.selectAll('.circle-overlay').classed('hidden', true);
			d3.selectAll('.node-icon').classed('node-icon--faded', false);
			// don't fix last node to center anymore
			if (lastNode) {
				lastNode.fx = null;
				lastNode.fy = null;
				node.filter((d, i) => i === lastNode.index)
					.transition().duration(2000).ease(d3.easePolyOut)
					.tween('circleOut', () => {
						let irl = d3.interpolateNumber(lastNode.r, lastNode.radius);
						return (t) => {
							lastNode.r = irl(t);
						}
					})
					.on('interrupt', () => {
						lastNode.r = lastNode.radius;
					});
			}
			// if (!d3.event.active) simulation.alphaTarget(0.5).restart();
			d3.transition().duration(2000).ease(d3.easePolyOut)
				.tween('moveIn', () => {
					console.log('tweenMoveIn', currentNode);
					let ix = d3.interpolateNumber(currentNode.x, centerX);
					let iy = d3.interpolateNumber(currentNode.y, centerY);
					let ir = d3.interpolateNumber(currentNode.r, centerY * 0.5);
					return function (t) {
						// console.log('i', ix(t), iy(t));
						currentNode.fx = ix(t);
						currentNode.fy = iy(t);
						currentNode.r = ir(t);
						simulation.force('collide', forceCollide);
					};
				})
				.on('end', () => {
					simulation.alphaTarget(0);
					let $currentGroup = d3.select(currentTarget);
					$currentGroup.select('.circle-overlay')
						.classed('hidden', false);
					$currentGroup.select('.node-icon')
						.classed('node-icon--faded', true);
				})
				.on('interrupt', () => {
					console.log('move interrupt', currentNode);
					currentNode.fx = null;
					currentNode.fy = null;
					simulation.alphaTarget(0);
				});
		});
		// blur
		d3.select(document).on('click', () => {
			let target = d3.event.target;
			// check if click on document but not on the circle overlay
			if (!target.closest('#circle-overlay') && focusedNode) {
				focusedNode.fx = null;
				focusedNode.fy = null;
				simulation.alphaTarget(0.2).restart();
				d3.transition().duration(2000).ease(d3.easePolyOut)
					.tween('moveOut', function () {
						console.log('tweenMoveOut', focusedNode);
						let ir = d3.interpolateNumber(focusedNode.r, focusedNode.radius);
						return function (t) {
							focusedNode.r = ir(t);
							simulation.force('collide', forceCollide);
						};
					})
					.on('end', () => {
						focusedNode = null;
						simulation.alphaTarget(0);
					})
					.on('interrupt', () => {
						simulation.alphaTarget(0);
					});
				// hide all circle-overlay
				d3.selectAll('.circle-overlay').classed('hidden', true);
				d3.selectAll('.node-icon').classed('node-icon--faded', false);
			}
		});
		function ticked() {
			node
				.attr('transform', d => `translate(${d.x},${d.y})`)
				.select('circle')
					.attr('r', d => d.r);
		}
	</script>
</body>
</html>
